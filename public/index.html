<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Icon Explorer</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
                    system-ui, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                color: #333;
            }

            .container {
                max-width: 1400px;
                margin: 0 auto;
                padding: 2rem;
            }

            .header {
                text-align: center;
                margin-bottom: 3rem;
            }

            .header h1 {
                color: white;
                font-size: 3rem;
                font-weight: 700;
                margin-bottom: 0.5rem;
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            }

            .header p {
                color: rgba(255, 255, 255, 0.9);
                font-size: 1.1rem;
            }

            .controls {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(20px);
                border-radius: 20px;
                padding: 2rem;
                margin-bottom: 2rem;
                box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
                border: 1px solid rgba(255, 255, 255, 0.18);
            }

            .search-bar {
                display: flex;
                gap: 1rem;
                margin-bottom: 1.5rem;
                flex-wrap: wrap;
            }

            .search-input {
                flex: 1;
                min-width: 300px;
                padding: 12px 20px;
                border: 2px solid #e1e5e9;
                border-radius: 50px;
                font-size: 16px;
                transition: all 0.3s ease;
                background: white;
            }

            .search-input:focus {
                outline: none;
                border-color: #667eea;
                box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            }

            .filter-controls {
                display: flex;
                gap: 1rem;
                align-items: center;
                flex-wrap: wrap;
            }

            .filter-group {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .filter-group label {
                font-weight: 600;
                color: #4a5568;
            }

            select {
                padding: 8px 12px;
                border: 2px solid #e1e5e9;
                border-radius: 8px;
                background: white;
                font-size: 14px;
                cursor: pointer;
                transition: border-color 0.3s ease;
            }

            select:focus {
                outline: none;
                border-color: #667eea;
            }

            .stats {
                text-align: center;
                color: #6b7280;
                font-size: 14px;
                margin-bottom: 1rem;
            }

            .icons-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 1.5rem;
                margin-top: 2rem;
            }

            .icon-card {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(20px);
                border-radius: 16px;
                padding: 1.5rem;
                text-align: center;
                transition: all 0.3s ease;
                border: 1px solid rgba(255, 255, 255, 0.18);
                box-shadow: 0 4px 16px rgba(31, 38, 135, 0.2);
                cursor: pointer;
                position: relative;
                overflow: hidden;
            }

            .icon-card:hover {
                transform: translateY(-4px);
                box-shadow: 0 12px 32px rgba(31, 38, 135, 0.3);
            }

            .icon-card::before {
                content: "";
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(
                    90deg,
                    transparent,
                    rgba(255, 255, 255, 0.4),
                    transparent
                );
                transition: left 0.5s;
            }

            .icon-card:hover::before {
                left: 100%;
            }

            .icon-preview {
                width: 64px;
                height: 64px;
                margin: 0 auto 1rem;
                display: flex;
                align-items: center;
                justify-content: center;
                background: #f8fafc;
                border-radius: 12px;
                position: relative;
                z-index: 1;
            }

            .icon-preview svg {
                max-width: 48px;
                max-height: 48px;
                color: #4a5568;
            }

            .icon-name {
                font-weight: 600;
                color: #2d3748;
                margin-bottom: 0.5rem;
                font-size: 14px;
                word-break: break-all;
            }

            .icon-details {
                font-size: 12px;
                color: #718096;
                line-height: 1.4;
            }

            .icon-actions {
                margin-top: 1rem;
                display: flex;
                gap: 0.5rem;
                justify-content: center;
            }

            .btn {
                padding: 6px 12px;
                border: none;
                border-radius: 6px;
                font-size: 12px;
                cursor: pointer;
                transition: all 0.2s ease;
                font-weight: 500;
            }

            .btn-primary {
                background: #667eea;
                color: white;
            }

            .btn-primary:hover {
                background: #5a67d8;
                transform: translateY(-1px);
            }

            .btn-secondary {
                background: #e2e8f0;
                color: #4a5568;
            }

            .btn-secondary:hover {
                background: #cbd5e0;
                transform: translateY(-1px);
            }

            .loading-screen {
                display: flex;
                align-items: center;
                justify-content: center;
                min-height: 400px;
                color: white;
            }

            .loading-content {
                text-align: center;
                max-width: 400px;
                padding: 2rem;
            }

            .loading-spinner {
                width: 60px;
                height: 60px;
                border: 4px solid rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                border-top-color: white;
                animation: spin 1s linear infinite;
                margin: 0 auto 2rem;
            }

            .loading-content h2 {
                font-size: 2rem;
                margin-bottom: 0.5rem;
                font-weight: 600;
            }

            .loading-content p {
                font-size: 1.1rem;
                opacity: 0.9;
                margin-bottom: 2rem;
            }

            .loading-progress {
                width: 100%;
            }

            .progress-bar {
                width: 100%;
                height: 8px;
                background: rgba(255, 255, 255, 0.2);
                border-radius: 4px;
                overflow: hidden;
                margin-bottom: 1rem;
            }

            .progress-fill {
                height: 100%;
                background: linear-gradient(90deg, #4ade80, #22c55e);
                border-radius: 4px;
                width: 0%;
                transition: width 0.3s ease;
                box-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
            }

            .progress-text {
                font-size: 0.9rem;
                opacity: 0.8;
                font-weight: 500;
            }

            .loading {
                text-align: center;
                padding: 4rem 2rem;
                color: white;
                font-size: 1.1rem;
            }

            .loading::after {
                content: "";
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 2px solid rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                border-top-color: white;
                animation: spin 1s ease-in-out infinite;
                margin-left: 10px;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            .no-results {
                text-align: center;
                padding: 4rem 2rem;
                color: rgba(255, 255, 255, 0.8);
                font-size: 1.1rem;
                width: 100%;
                height: 100%;
            }

            @media (max-width: 768px) {
                .container {
                    padding: 1rem;
                }

                .header h1 {
                    font-size: 2rem;
                }

                .controls {
                    padding: 1.5rem;
                }

                .search-bar {
                    flex-direction: column;
                }

                .search-input {
                    min-width: auto;
                }

                .filter-controls {
                    flex-direction: column;
                    align-items: stretch;
                }

                .filter-group {
                    justify-content: space-between;
                }

                .icons-grid {
                    grid-template-columns: repeat(
                        auto-fill,
                        minmax(150px, 1fr)
                    );
                    gap: 1rem;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>Icon Explorer</h1>
                <p>Browse, search, and download your SVG icons</p>
            </div>

            <div class="controls">
                <div class="search-bar">
                    <input
                        type="text"
                        id="searchInput"
                        class="search-input"
                        placeholder="Search icons by name..."
                    />
                </div>

                <div class="filter-controls">
                    <div class="filter-group">
                        <label for="sortBy">Sort by:</label>
                        <select id="sortBy">
                            <option value="name">Name (A-Z)</option>
                            <option value="name-desc">Name (Z-A)</option>
                            <option value="size">File Size</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="viewSize">View:</label>
                        <select id="viewSize">
                            <option value="medium">Medium</option>
                            <option value="small">Small</option>
                            <option value="large">Large</option>
                        </select>
                    </div>
                </div>

                <div class="stats" id="stats">Loading icons...</div>
            </div>

            <div id="iconsContainer" class="loading-screen">
                <div class="loading-content">
                    <div class="loading-spinner"></div>
                    <h2>Starting Up</h2>
                    <p>Preparing your icon explorer...</p>
                </div>
            </div>
        </div>

        <script>
            let allIcons = [];
            let filteredIcons = [];
            let groupedIcons = new Map(); // Icons grouped by base name

            // Icon cache to store SVG content and avoid re-loading
            const iconCache = new Map();
            const loadingPromises = new Map(); // Track ongoing loads to avoid duplicates

            // Icon versions in order of preference
            const iconVersions = [
                "filled",
                "solid",
                "stroke",
                "duo_solid",
                "duo_stroke",
                "contrast",
                "bold",
            ];
            const defaultVersion = "filled";

            // Loading state management
            let iconsLoaded = false;
            let totalIconsToLoad = 0;
            let iconsLoadedCount = 0;

            // Load icons on page load
            document.addEventListener("DOMContentLoaded", loadIcons);

            // Search functionality
            document
                .getElementById("searchInput")
                .addEventListener("input", (e) => {
                    filterIcons();
                });

            // Sort functionality
            document
                .getElementById("sortBy")
                .addEventListener("change", (e) => {
                    filterIcons();
                });

            // View size functionality
            document
                .getElementById("viewSize")
                .addEventListener("change", (e) => {
                    updateViewSize();
                });

            async function loadIcons() {
                try {
                    showLoadingScreen();

                    const response = await fetch("/api/icons");
                    if (!response.ok) throw new Error("Failed to load icons");

                    allIcons = await response.json();

                    // Group icons by base name
                    groupIconsByBaseName();

                    // Create filtered list from grouped icons
                    filteredIcons = Array.from(groupedIcons.values());
                    totalIconsToLoad = allIcons.length;

                    // Pre-load all SVG icons into cache
                    await preloadAllIcons();

                    iconsLoaded = true;
                    filterIcons();
                } catch (error) {
                    console.error("Error loading icons:", error);
                    document.getElementById("iconsContainer").innerHTML = `
                    <div class="no-results">
                        Failed to load icons. Please make sure your server is running and you have SVG files in the /public/icons directory.
                    </div>
                `;
                }
            }

            function groupIconsByBaseName() {
                groupedIcons.clear();

                allIcons.forEach((icon) => {
                    const { baseName, version } = parseIconName(icon.name);

                    if (!groupedIcons.has(baseName)) {
                        groupedIcons.set(baseName, {
                            baseName,
                            versions: new Map(),
                            defaultVersion: null,
                            // Use first icon's metadata as base, will be updated with preferred version
                            size: icon.size,
                            dimensions: icon.dimensions,
                        });
                    }

                    const group = groupedIcons.get(baseName);
                    group.versions.set(version, icon);

                    // Update group metadata with preferred version or first available
                    if (
                        !group.defaultVersion ||
                        shouldPreferVersion(version, group.defaultVersion)
                    ) {
                        group.defaultVersion = version;
                        group.size = icon.size;
                        group.dimensions = icon.dimensions;
                        group.url = icon.url;
                        group.filename = icon.filename;
                    }
                });
            }

            function parseIconName(filename) {
                // Remove .svg extension
                const nameWithoutExt = filename.replace(/\.svg$/, "");

                // Find which version suffix this icon has
                for (const version of iconVersions) {
                    if (nameWithoutExt.endsWith("-" + version)) {
                        const baseName = nameWithoutExt.slice(
                            0,
                            -(version.length + 1),
                        );
                        return { baseName, version };
                    }
                }

                // If no version suffix found, treat the whole name as base with 'filled' as default
                return { baseName: nameWithoutExt, version: "filled" };
            }

            function shouldPreferVersion(newVersion, currentVersion) {
                const newIndex = iconVersions.indexOf(newVersion);
                const currentIndex = iconVersions.indexOf(currentVersion);

                // If new version is 'filled' (our preferred default), prefer it
                if (newVersion === defaultVersion) return true;
                if (currentVersion === defaultVersion) return false;

                // Otherwise prefer earlier in the iconVersions array
                return newIndex < currentIndex && newIndex !== -1;
            }

            async function preloadAllIcons() {
                const loadPromises = allIcons.map((icon) =>
                    preloadIcon(icon.url, icon.filename),
                );
                await Promise.all(loadPromises);
            }

            async function preloadIcon(url, filename) {
                if (iconCache.has(filename)) {
                    return iconCache.get(filename);
                }

                // Check if we're already loading this icon
                if (loadingPromises.has(filename)) {
                    return loadingPromises.get(filename);
                }

                const loadPromise = (async () => {
                    try {
                        const response = await fetch(url);
                        const svgText = await response.text();

                        // Process the SVG to ensure it displays correctly
                        const parser = new DOMParser();
                        const svgDoc = parser.parseFromString(
                            svgText,
                            "image/svg+xml",
                        );
                        const svg = svgDoc.querySelector("svg");

                        if (svg) {
                            svg.setAttribute("width", "48");
                            svg.setAttribute("height", "48");
                            const processedSvg = svg.outerHTML;
                            iconCache.set(filename, processedSvg);

                            iconsLoadedCount++;
                            updateLoadingProgress();

                            return processedSvg;
                        } else {
                            throw new Error("Invalid SVG");
                        }
                    } catch (error) {
                        console.error(`Error loading SVG ${filename}:`, error);
                        const fallbackSvg = `
                        <div style="display: flex; align-items: center; justify-content: center; height: 48px; color: #cbd5e0; font-size: 12px;">
                            SVG
                        </div>
                    `;
                        iconCache.set(filename, fallbackSvg);
                        iconsLoadedCount++;
                        updateLoadingProgress();
                        return fallbackSvg;
                    } finally {
                        loadingPromises.delete(filename);
                    }
                })();

                loadingPromises.set(filename, loadPromise);
                return loadPromise;
            }

            function showLoadingScreen() {
                const container = document.getElementById("iconsContainer");
                container.className = "loading-screen";
                container.innerHTML = `
                <div class="loading-content">
                    <div class="loading-spinner"></div>
                    <h2>Loading Your Icons</h2>
                    <p>Preparing your beautiful collection...</p>
                    <div class="loading-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="progress-text" id="progressText">0%</div>
                    </div>
                </div>
            `;
            }

            function updateLoadingProgress() {
                if (totalIconsToLoad === 0) return;

                const percentage = Math.round(
                    (iconsLoadedCount / totalIconsToLoad) * 100,
                );
                const progressFill = document.getElementById("progressFill");
                const progressText = document.getElementById("progressText");

                if (progressFill && progressText) {
                    progressFill.style.width = `${percentage}%`;
                    progressText.textContent = `${percentage}% (${iconsLoadedCount}/${totalIconsToLoad})`;
                }
            }

            function filterIcons() {
                const searchTerm = document
                    .getElementById("searchInput")
                    .value.toLowerCase();
                const sortBy = document.getElementById("sortBy").value;

                // Filter grouped icons by search term
                filteredIcons = Array.from(groupedIcons.values()).filter(
                    (iconGroup) =>
                        iconGroup.baseName.toLowerCase().includes(searchTerm),
                );

                // Sort icon groups
                filteredIcons.sort((a, b) => {
                    switch (sortBy) {
                        case "name":
                            return a.baseName.localeCompare(b.baseName);
                        case "name-desc":
                            return b.baseName.localeCompare(a.baseName);
                        case "size":
                            return a.size - b.size;
                        default:
                            return 0;
                    }
                });

                renderIcons();
                updateStats();
            }

            function renderIcons() {
                const container = document.getElementById("iconsContainer");

                if (filteredIcons.length === 0) {
                    container.innerHTML = `
                    <div class="no-results">
                        No icons found matching your search criteria.
                    </div>
                `;
                    return;
                }

                container.innerHTML = "";
                container.className = "icons-grid";

                filteredIcons.forEach((iconGroup) => {
                    const iconCard = createIconCard(iconGroup);
                    container.appendChild(iconCard);
                });
            }

            function createIconCard(iconGroup) {
                const card = document.createElement("div");
                card.className = "icon-card";

                // Get current selected version or default
                const currentVersion = iconGroup.defaultVersion;
                const currentIcon = iconGroup.versions.get(currentVersion);

                const sizeInKB = (currentIcon.size / 1024).toFixed(1);

                // Create version options
                const versionOptions = Array.from(iconGroup.versions.keys())
                    .sort(
                        (a, b) =>
                            iconVersions.indexOf(a) - iconVersions.indexOf(b),
                    )
                    .map((version) => {
                        const selected =
                            version === currentVersion ? "selected" : "";
                        const versionLabel =
                            version.charAt(0).toUpperCase() +
                            version.slice(1).replace("-", " ");
                        return `<option value="${version}" ${selected}>${versionLabel}</option>`;
                    })
                    .join("")
                    .replace("Duo_solid", "Duo Solid")
                    .replace("Duo_stroke", "Duo Stroke")
                    .replace("Bold", "Stroke");

                card.innerHTML = `
                <div class="icon-preview" data-icon-group="${iconGroup.baseName}">
                    <svg width="48" height="48" viewBox="0 0 24 24">
                        <use href="${currentIcon.url}#icon"></use>
                    </svg>
                </div>
                <div class="icon-name">${iconGroup.baseName}</div>
                <div class="version-selector">
                    <select onchange="changeIconVersion('${iconGroup.baseName}', this.value)">
                        ${versionOptions}
                    </select>
                </div>
                <!--<div class="icon-details">
                    ${currentIcon.dimensions} • ${sizeInKB} KB<br>
                </div>-->
                <div class="icon-actions">
                    <button class="btn btn-primary" onclick="downloadIcon('${currentIcon.filename}')">
                        Download
                    </button>
                    <button class="btn btn-secondary" onclick="copyIcon('${currentIcon.url}')">
                        Copy SVG
                    </button>
                </div>
            `;

                // Load the cached SVG content instantly
                loadCachedSVGPreview(
                    card.querySelector(".icon-preview"),
                    currentIcon.filename,
                );

                return card;
            }

            function loadCachedSVGPreview(container, filename) {
                const cachedSvg = iconCache.get(filename);
                if (cachedSvg) {
                    container.innerHTML = cachedSvg;
                } else {
                    // Fallback if somehow not cached
                    container.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 48px; color: #cbd5e0; font-size: 12px;">
                        SVG
                    </div>
                `;
                }
            }

            async function loadSVGPreview(container, url) {
                try {
                    const response = await fetch(url);
                    const svgText = await response.text();
                    container.innerHTML = svgText;

                    const svg = container.querySelector("svg");
                    if (svg) {
                        svg.setAttribute("width", "48");
                        svg.setAttribute("height", "48");
                    }
                } catch (error) {
                    console.error("Error loading SVG preview:", error);
                    container.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 48px; color: #cbd5e0; font-size: 12px;">
                        SVG
                    </div>
                `;
                }
            }

            function updateStats() {
                const totalGroups = groupedIcons.size;
                const showing = filteredIcons.length;
                const totalIcons = allIcons.length;
                const statsElement = document.getElementById("stats");

                if (totalGroups === showing) {
                    statsElement.textContent = `Showing all ${totalGroups} icons (${totalIcons} total variants)`;
                } else {
                    statsElement.textContent = `Showing ${showing} of ${totalGroups} icons (${totalIcons} total variants)`;
                }
            }

            function changeIconVersion(baseName, newVersion) {
                const iconGroup = groupedIcons.get(baseName);
                if (!iconGroup || !iconGroup.versions.has(newVersion)) return;

                const newIcon = iconGroup.versions.get(newVersion);
                const card = document
                    .querySelector(`[data-icon-group="${baseName}"]`)
                    .closest(".icon-card");

                // Update the preview
                const preview = card.querySelector(".icon-preview");
                loadCachedSVGPreview(preview, newIcon.filename);

                // Update the details
                const sizeInKB = (newIcon.size / 1024).toFixed(1);

                const details = card.querySelector(".icon-details");
                details.innerHTML = `
                ${newIcon.dimensions} • ${sizeInKB} KB<br>
            `;

                // Update the download button
                const downloadBtn = card.querySelector(".btn-primary");
                downloadBtn.setAttribute(
                    "onclick",
                    `downloadIcon('${newIcon.filename}')`,
                );

                // Update the copy URL button
                const copyBtn = card.querySelector(".btn-secondary");
                copyBtn.setAttribute("onclick", `copyIcon('${newIcon.url}')`);
            }

            function updateViewSize() {
                const viewSize = document.getElementById("viewSize").value;
                const grid = document.querySelector(".icons-grid");

                if (!grid) return;

                switch (viewSize) {
                    case "small":
                        grid.style.gridTemplateColumns =
                            "repeat(auto-fill, minmax(150px, 1fr))";
                        break;
                    case "large":
                        grid.style.gridTemplateColumns =
                            "repeat(auto-fill, minmax(280px, 1fr))";
                        break;
                    default: // medium
                        grid.style.gridTemplateColumns =
                            "repeat(auto-fill, minmax(200px, 1fr))";
                }
            }

            async function downloadIcon(filename) {
                try {
                    const response = await fetch(`/api/download/${filename}`);
                    if (!response.ok) throw new Error("Download failed");

                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                } catch (error) {
                    console.error("Error downloading icon:", error);
                    alert("Failed to download icon");
                }
            }

            async function copyIcon(url) {
                try {
                    // Fetch the SVG content
                    const response = await fetch(url);
                    const svgContent = await response.text();

                    await navigator.clipboard.writeText(svgContent);

                    // Simple feedback - you could enhance this with a toast notification
                    const btn = event.target;
                    const originalText = btn.textContent;
                    btn.textContent = "Copied!";
                    btn.style.background = "#48bb78";
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = "";
                    }, 1500);
                } catch (err) {
                    console.error("Failed to copy SVG:", err);
                }
            }
        </script>
    </body>
</html>
